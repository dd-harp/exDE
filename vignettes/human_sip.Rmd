---
title: "SIP (Susceptible-Infected-Prophylaxis) Human Model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SIP (Susceptible-Infected-Prophylaxis) Human Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The basic SIP (Susceptible-Infected-Prophylaxis) human model model fulfills the generic interface of the human population component. It is a reasonable first complication of the [SIS human model](human_sis.html). This requires two new parameters, $\rho$, the probability a new infection is treated, and $\eta$ the duration of chemoprophylaxis following treatment. $X$ remains a column vector giving the number of infectious individuals in each strata, and $P$ the number of treated and protected individuals.

# Differential Equations

The equations are as follows:

$$
\dot{X} = \mbox{diag}((1-\rho)bEIR)\cdot (H-X-P) - (r+\xi)X
$$

$$
\dot{P} = \mbox{diag}(\rho b EIR) \cdot (H-X-P) + \xi(H-P) - \eta P
$$

# Equilibrium solutions

Again, we assume $H$ and $X$ to be known, we set $\xi=0$, and we solve for $EIR$ and $P$.

$$
P = \mbox{diag}(1/\eta) \cdot \mbox{diag}(\rho/(1-\rho)) \cdot rX
$$

$$
EIR = \mbox{diag}(1/b) \cdot \mbox{diag}(1/(1-\rho)) \cdot \left( \frac{rX}{H-X-P} \right)
$$

Given $EIR$ we can solve for the mosquito population which would have given rise to those equilibrium values.

# Example

```{r, message=FALSE, warning=FALSE}
library(exDE)
#devtools::load_all(".")
library(deSolve)
library(data.table)
library(ggplot2)
```

Here we run a simple example with 3 population strata at equilibrium. We use `exDE::make_parameters_X_SIP` to
set up parameters. Please note that this only runs the human population component and that most users should read [our fully worked example](ex_534.html) to run a full simulation.

We use the null (constant) model of human demography ($H$ constant for all time).

## The Long Way

```{r}
nStrata <- 3
H <- c(100, 500, 250)
residence <- rep(1,3) 
searchWtsH <- rep(1,3) 
X <- c(20, 120, 80)
b <- 0.55
c <- 0.15
r <- 1/200
eta <- c(1/30, 1/40, 1/35)
rho <- c(0.05, 0.1, 0.15)
xi <- rep(0, 3) 
TaR <- matrix(data = 1,nrow = 1, ncol = nStrata)

P <- diag(1/eta) %*% diag(rho/(1-rho)) %*% (r*X)
EIR <- diag(1/b, nStrata) %*% diag(1/(1-rho)) %*% ((r*X)/(H-X-P))
```


```{r} 
params <- make_parameters_xde()
params$nStrata = nStrata
params$nPatches = 1 

params$eir = EIR 
F_eir = function(t, pars){
  pars$eir
}

params = make_parameters_demography_null(pars = params, H=H, residence=residence, searchWts=searchWtsH, TaR=TaR)

params = make_parameters_X_SIP(pars = params, b = b, c = c, r = r, rho = rho, eta = eta, xi=xi)
params = make_inits_X_SIP(pars = params, X, as.vector(P))
params = make_indices(params)
```

```{r} 
y0 <- get_inits_X(params)
out <- deSolve::ode(y = y0, times = c(0, 365), xDE_diffeqn_cohort, parms = params, method = 'lsoda', F_eir = F_eir) 
out1<- out
```
 
```{r, out.width = "100%"}
colnames(out)[params$Xpar$X_ix+1] <- paste0('X_', 1:params$nStrata)
colnames(out)[params$Xpar$P_ix+1] <- paste0('P_', 1:params$nStrata)

out <- as.data.table(out)
out <- melt(out, id.vars = 'time')
out[, c("Component", "Strata") := tstrsplit(variable, '_', fixed = TRUE)]
out[, variable := NULL]

ggplot(data = out, mapping = aes(x = time, y = value, color = Strata)) +
  geom_line() +
  facet_wrap(. ~ Component, scales = 'free') +
  theme_bw()
```

## Using Setup


```{r}
Xo = list(b=0.55, c=0.15, r=1/200, eta = c(1/30, 1/40, 1/35), rho = c(0.05, .1, 0.15), xi = rep(0,3), X0 = X, P0=as.vector(P))
Hpop = c(100, 500, 250)
```

To use `xde_setup_cohort` we must set up a function `F_eir` returns the value of EIR we computed above:  

```{r}
EIR 
```
```{r}
F_eir1 = function(t, pars){
  0.05454545 
}
```

```{r}
xde_setup_cohort("test_SIP", F_eir1, "SIP", HPop=Hpop, Xopts = Xo) -> test_SIP
```

```{r}
xde_solve(test_SIP, 365, 365)$deout -> out2
approx_equal(out2,out1)
```

